<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Meeting Room</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
            color: white;
        }

        /* Layout */
        #container {
            display: flex;
            height: 100vh;
        }

        #videoGrid {
            flex: 3;
            display: grid;
            gap: 0.5rem;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            padding: 1rem;
            overflow-y: auto;
        }

        .video-container {
            position: relative;
            width: 100%;
            padding-top: 56.25%;
            background: #222;
            border-radius: 12px;
            overflow: hidden;
        }

        .video-element {
            position: absolute;
            top: 0; left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .status-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            background: rgba(0,0,0,0.7);
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 12px;
        }

        #chatBox {
            flex: 1;
            display: flex;
            flex-direction: column;
            border-left: 1px solid #444;
            background: #111;
        }

        #messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }

        #chatInput {
            padding: 0.5rem;
            border: none;
            outline: none;
            width: calc(100% - 1rem);
            margin: 0.5rem;
            border-radius: 6px;
        }

        #sendBtn {
            background: #0f62fe;
            padding: 0.5rem 1rem;
            margin: 0.5rem;
            border-radius: 6px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <!-- Video Grid -->
        <div id="videoGrid">
            <div class="video-container" id="mainVideoContainer">
                <video id="localVideo" autoplay muted class="video-element"></video>
                <span class="status-badge" id="localStatus">Active</span>
            </div>
        </div>

        <!-- Chat Box -->
        <div id="chatBox">
            <div id="messages"></div>
            <input type="text" id="chatInput" placeholder="Type a message..."/>
            <button id="sendBtn">Send</button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
    <script>
        const socket = io(); // connect to backend

        const localVideo = document.getElementById('localVideo');
        const videoGrid = document.getElementById('videoGrid');
        const messagesDiv = document.getElementById('messages');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const localStatus = document.getElementById('localStatus');

        let peers = {};
        let username = prompt("Enter your name:") || "Anonymous_" + Math.floor(Math.random()*1000);
        let room = "shared-room"; // for demo, single room

        // Join the room
        socket.emit("join", { room, username });

        // Chat
        sendBtn.addEventListener('click', () => {
            const msg = chatInput.value.trim();
            if (!msg) return;
            socket.emit("chat", { msg, room });
            chatInput.value = "";
        });

        socket.on("chat", data => {
            const p = document.createElement('p');
            p.textContent = `${data.user}: ${data.msg}`;
            messagesDiv.appendChild(p);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        });

        // Video capture
        let localStream;
        navigator.mediaDevices.getUserMedia({ video: true, audio: true })
        .then(stream => {
            localStream = stream;
            localVideo.srcObject = stream;

            // Send frames every 1s for emotion detection
            setInterval(() => {
                const canvas = document.createElement("canvas");
                canvas.width = localVideo.videoWidth;
                canvas.height = localVideo.videoHeight;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(localVideo, 0, 0, canvas.width, canvas.height);
                const dataUrl = canvas.toDataURL("image/jpeg");
                socket.emit("frame", dataUrl);
            }, 1000);
        });

        // Emotion prediction
        socket.on("prediction", data => {
            if (data.category === "Active") {
                localStatus.textContent = "Active";
                localStatus.style.backgroundColor = "green";
            } else {
                localStatus.textContent = "Inactive";
                localStatus.style.backgroundColor = "red";
            }
        });

        // Server alert
        socket.on("alert", data => {
            alert(data.message);
        });
    </script>
</body>
</html>
